# ุณุณุชู ุฏูุงูฺฉ RBAC

## Role-Based Access Control System

ุงู ุณูุฏ ุฑุงูููุง ฺฉุงูู ุจุฑุง ุงุณุชูุงุฏูุ ูุฏุฑุช ู ุชูุณุนู ุณุณุชู RBAC ุฏูุงูฺฉ ูพูุชูุฑู PlusMeet ุงุณุช.

---

## ๐ ููุฑุณุช ูุทุงูุจ

1. [ูุนุฑู](#ูุนุฑู)
2. [ูุนูุงุฑ ุณุณุชู](#ูุนูุงุฑ-ุณุณุชู)
3. [ูุฏูโูุง ุฏุงุฏู](#ูุฏููุง-ุฏุงุฏู)
4. [API Endpoints](#api-endpoints)
5. [ุฑุงุจุท ฺฉุงุฑุจุฑ Admin](#ุฑุงุจุท-ฺฉุงุฑุจุฑ-admin)
6. [ูุญูู ุงุณุชูุงุฏู](#ูุญูู-ุงุณุชูุงุฏู)
7. [ุงููุช](#ุงููุช)
8. [ูุซุงูโูุง ฺฉุงุฑุจุฑุฏ](#ูุซุงููุง-ฺฉุงุฑุจุฑุฏ)

---

## ูุนุฑู

ุณุณุชู RBAC ุฏูุงูฺฉ ุงูฺฉุงู ูุฏุฑุช ฺฉุงูู ููุดโูุง ู ุฏุณุชุฑุณโูุง ุฑุง ุจุฏูู ูุงุฒ ุจู ุชุบุฑ ฺฉุฏ ูุฑุงูู ูโฺฉูุฏ.

### ูฺฺฏโูุง ฺฉูุฏ

- โ **ููุดโุณุงุฒ ุฏูุงูฺฉ**: ุงุฌุงุฏุ ูุฑุงุด ู ุญุฐู ููุดโูุง ุจุฏูู ุชุบุฑ ฺฉุฏ
- โ **ุฏุณุชุฑุณ ููู**: ฺฉูุชุฑู ุฏุณุชุฑุณ ุจู ููููุง ูพูู ุจุง ุณุงุฎุชุงุฑ ุฏุฑุฎุช
- โ **ุฏุณุชุฑุณ API**: ฺฉูุชุฑู ุฏูู ุฏุณุชุฑุณ ุจู ูุฑ ูุชุฏ HTTP ุจุฑุง ูุฑ endpoint
- โ **ููุดโูุง ุณุณุชู**: ููุดโูุง ุงุฒ ูพุด ุชุนุฑู ุดุฏู ฺฉู ูุงุจู ุญุฐู ูุณุชูุฏ
- โ **ุฑุงุจุท ฺฉุงุฑุจุฑ ุฒุจุง**: UI ูุฏุฑู ู ฺฉุงุฑุจุฑูพุณูุฏ ุจุฑุง ูุฏุฑุช
- โ **Seeding**: ุงุฌุงุฏ ุฎูุฏฺฉุงุฑ ุฏุงุฏูโูุง ุงููู

---

## ูุนูุงุฑ ุณุณุชู

### ูุงูโูุง ุณุณุชู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Frontend UI (Admin Panel)         โ
โ   - Role List                        โ
โ   - Role Edit Form                   โ
โ   - Menu Tree View                   โ
โ   - API Permission Grid              โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
               โ
โโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโ
โ   API Routes                         โ
โ   - /api/admin/rbac/roles            โ
โ   - /api/admin/rbac/menus            โ
โ   - /api/admin/rbac/apis             โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
               โ
โโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโ
โ   Middleware                         โ
โ   - authenticate()                   โ
โ   - checkApiPermission()             โ
โ   - checkMenuPermission()            โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
               โ
โโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโ
โ   Database Models                    โ
โ   - Role                             โ
โ   - Menu                             โ
โ   - ApiEndpoint                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ูุฏูโูุง ุฏุงุฏู

### 1. Role Model

```javascript
{
  name: String,              // ูุงู ููุด (ูุซูุงู "ูุฏุฑ ูุญุชูุง")
  slug: String,              // ุดูุงุณู ฺฉุชุง (ูุซูุงู "content_manager")
  description: String,       // ุชูุถุญุงุช ููุด
  isSystem: Boolean,         // ุขุง ููุด ุณุณุชู ุงุณุชุ
  menuPermissions: [         // ุฏุณุชุฑุณ ุจู ููููุง
    {
      menuId: String,
      access: "view" | "full"
    }
  ],
  apiPermissions: [          // ุฏุณุชุฑุณ ุจู API ูุง
    {
      path: String,
      methods: ["GET", "POST", "PUT", "DELETE"]
    }
  ]
}
```

### 2. Menu Model

```javascript
{
  menuId: String,            // ุดูุงุณู ฺฉุชุง (ูุซูุงู "users")
  title: { fa, en },         // ุนููุงู ููู
  path: String,              // ูุณุฑ (ูุซูุงู "/admin/users")
  parentId: String,          // ุดูุงุณู ููู ูุงูุฏ (ุจุฑุง ุฒุฑููููุง)
  icon: String,              // ุขฺฉูู
  order: Number,             // ุชุฑุชุจ ููุงุด
  isActive: Boolean,         // ูุนุงู/ุบุฑูุนุงู
  isVisible: Boolean,        // ููุงุด/ุนุฏู ููุงุด
  defaultRoles: [String]     // ููุดโูุง ูพุดโูุฑุถ
}
```

### 3. ApiEndpoint Model

```javascript
{
  path: String,              // ูุณุฑ API (ูุซูุงู "/api/admin/users")
  availableMethods: [String], // ูุชุฏูุง ููุฌูุฏ
  module: String,            // ูุงฺูู (ูุซูุงู "users")
  category: String,          // ุฏุณุชูโุจูุฏ
  title: String,             // ุนููุงู
  description: String,       // ุชูุถุญุงุช
  defaultRoles: [String],    // ููุดโูุง ูพุดโูุฑุถ
  isPublic: Boolean,         // ุนููู ุง ุฎุตูุต
  isActive: Boolean          // ูุนุงู/ุบุฑูุนุงู
}
```

---

## API Endpoints

### Roles Management

#### `GET /api/admin/rbac/roles`

ุฏุฑุงูุช ูุณุช ููุดโูุง

**Query Parameters:**

- `includeSystem`: ุดุงูู ููุดโูุง ุณุณุชู (default: true)
- `onlyActive`: ููุท ููุดโูุง ูุนุงู (default: false)

**Response:**

```json
{
  "success": true,
  "data": {
    "roles": [...],
    "count": 3
  }
}
```

#### `POST /api/admin/rbac/roles`

ุงุฌุงุฏ ููุด ุฌุฏุฏ

**Body:**

```json
{
  "name": "ูุฏุฑ ูุญุชูุง",
  "slug": "content_manager",
  "description": "ูุฏุฑุช ูุญุชูุง ุณุงุช",
  "isSystem": false,
  "menuPermissions": [...],
  "apiPermissions": [...]
}
```

#### `GET /api/admin/rbac/roles/:id`

ุฏุฑุงูุช ุงุทูุงุนุงุช ฺฉ ููุด

#### `PUT /api/admin/rbac/roles/:id`

ูุฑุงุด ููุด

#### `DELETE /api/admin/rbac/roles/:id`

ุญุฐู ููุด (ููุดโูุง ุณุณุชู ูุงุจู ุญุฐู ูุณุชูุฏ)

### Menus Management

#### `GET /api/admin/rbac/menus`

ุฏุฑุงูุช ูุณุช ููููุง

**Query Parameters:**

- `asTree`: ููุงุด ุจู ุตูุฑุช ุฏุฑุฎุช (default: false)

### API Endpoints Management

#### `GET /api/admin/rbac/apis`

ุฏุฑุงูุช ูุณุช API Endpoints

**Query Parameters:**

- `grouped`: ฺฏุฑููโุจูุฏ ุจุฑ ุงุณุงุณ ูุงฺูู (default: false)

### Seeding

#### `POST /api/admin/rbac/seed`

ุงุฌุงุฏ ุฏุงุฏูโูุง ุงููู (ููููุงุ API ูุงุ ููุดโูุง ุณุณุชู)

---

## ุฑุงุจุท ฺฉุงุฑุจุฑ Admin

### 1. ุตูุญู ูุณุช ููุดโูุง

**ูุณุฑ:** `/admin/rbac/roles`

**ุงูฺฉุงูุงุช:**

- ููุงุด ูุณุช ููุดโูุง ุจู ุตูุฑุช ฺฉุงุฑุช
- ููุชุฑ ุจุฑ ุงุณุงุณ ููุน (ูููุ ุณุณุชูุ ุณูุงุฑุด)
- ุฌุณุชุฌู ุฏุฑ ููุดโูุง
- ุขูุงุฑ ฺฉู (ุชุนุฏุงุฏ ฺฉูุ ุณุณุชูุ ุณูุงุฑุด)
- ุฏฺฉููโูุง ูุฑุงุด ู ุญุฐู ุจุฑุง ูุฑ ููุด

### 2. ุตูุญู ูุฑุงุด/ุงุฌุงุฏ ููุด

**ูุณุฑ:** `/admin/rbac/roles/new` ุง `/admin/rbac/roles/:id`

**ุชุจโูุง:**

#### ุชุจ 1: ุงุทูุงุนุงุช ูพุงู

- ูุงู ููุด
- ุดูุงุณู (Slug)
- ุชูุถุญุงุช
- ููุด ุณุณุชู (ููุท ุฏุฑ ุญุงูุช ุงุฌุงุฏ)

#### ุชุจ 2: ุฏุณุชุฑุณ ุจู ููููุง

- ููุงุด ุฏุฑุฎุช ููููุง
- ุงูุชุฎุงุจ ุฏุณุชุฑุณ ุจุฑุง ูุฑ ููู:
  - ๐๏ธ **ูุดุงูุฏู**: ููุท ูุดุงูุฏู ููู
  - ๐ **ุฏุณุชุฑุณ ฺฉุงูู**: ูุดุงูุฏู + ุนููุงุช

#### ุชุจ 3: ุฏุณุชุฑุณ ุจู API

- ููุงุด ุฏุณุชูโุจูุฏ ุดุฏู API Endpoints
- ุงูุชุฎุงุจ ูุชุฏูุง HTTP ุจุฑุง ูุฑ endpoint:
  - **GET**: ูุดุงูุฏู
  - **POST**: ุงุฌุงุฏ
  - **PUT**: ูุฑุงุด
  - **DELETE**: ุญุฐู

---

## ูุญูู ุงุณุชูุงุฏู

### 1. ุงุฌุฑุง Seed (ุงููู ุจุงุฑ)

ุงุฒ ุทุฑู UI:

```
1. ูุงฺฏู ุจู ูพูู ุงุฏูู
2. ุจู ูุณุฑ /admin/rbac/seed ุจุฑูุฏ
3. ุฏฺฉูู "ุงุฌุฑุง Seed" ุฑุง ฺฉูฺฉ ฺฉูุฏ
```

ุง ุงุฒ ุทุฑู Terminal:

```bash
npm run seed-rbac
```

### 2. ุงุฌุงุฏ ููุด ุฌุฏุฏ

```
1. ุจู /admin/rbac/roles ุจุฑูุฏ
2. ุฑู "ุงุฌุงุฏ ููุด ุฌุฏุฏ" ฺฉูฺฉ ฺฉูุฏ
3. ุงุทูุงุนุงุช ูพุงู ุฑุง ูุงุฑุฏ ฺฉูุฏ
4. ุฏุณุชุฑุณโูุง ููู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ
5. ุฏุณุชุฑุณโูุง API ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ
6. ุฐุฎุฑู ฺฉูุฏ
```

### 3. ูุฑุงุด ููุด ููุฌูุฏ

```
1. ุฏุฑ ุตูุญู ูุณุช ููุดโูุง ุฑู "ูุฑุงุด" ฺฉูฺฉ ฺฉูุฏ
2. ุชุบุฑุงุช ููุฑุฏ ูุธุฑ ุฑุง ุงุนูุงู ฺฉูุฏ
3. ุฐุฎุฑู ฺฉูุฏ
```

### 4. ุญุฐู ููุด

```
1. ุฏุฑ ุตูุญู ูุณุช ููุดโูุง ุฑู "ุญุฐู" ฺฉูฺฉ ฺฉูุฏ
2. ุชุงุฏ ฺฉูุฏ
```

โ๏ธ **ุชูุฌู:** ููุดโูุง ุณุณุชู ูุงุจู ุญุฐู ูุณุชูุฏ.

---

## ุงููุช

### ุงุญุฑุงุฒ ููุช

ุชูุงู API ูุง RBAC ูุงุฒููุฏ ุงุญุฑุงุฒ ููุช ูุณุชูุฏ ู ููุท ุงุฏููโูุง ูโุชูุงููุฏ ุจู ุขูโูุง ุฏุณุชุฑุณ ุฏุงุดุชู ุจุงุดูุฏ.

```javascript
// ุฏุฑ ูุฑ API Route:
const authResult = await authenticate(request);
if (!authResult.success || !authResult.user.roles?.includes("admin")) {
  return NextResponse.json(
    { success: false, error: "ุฏุณุชุฑุณ ุบุฑูุฌุงุฒ" },
    { status: 403 }
  );
}
```

### ูุญุงูุธุช ุงุฒ ููุดโูุง ุณุณุชู

ููุดโูุง ุจุง `isSystem: true` ูุงุจู ุญุฐู ูุณุชูุฏ ู ุญุฐู ุขูโูุง ุจุง ุฎุทุง ููุงุฌู ูโุดูุฏ.

### Activity Logging

ุชูุงู ุนููุงุช ุจุฑ ุฑู ููุดโูุง ูุงฺฏ ูโุดููุฏ:

```javascript
await logActivity({
  userId: user._id,
  action: "role_create",
  targetType: "Role",
  targetId: newRole._id,
  metadata: { roleName: newRole.name },
});
```

---

## ูุซุงูโูุง ฺฉุงุฑุจุฑุฏ

### ูุซุงู 1: ุงุฌุงุฏ ููุด "ูุฏุฑ ูุญุชูุง"

```json
{
  "name": "ูุฏุฑ ูุญุชูุง",
  "slug": "content_manager",
  "description": "ูุฏุฑุช ููุงูุงุชุ ุงุฎุจุงุฑ ู ูุญุชูุง ุณุงุช",
  "isSystem": false,
  "menuPermissions": [
    { "menuId": "dashboard", "access": "view" },
    { "menuId": "articles", "access": "full" },
    { "menuId": "media", "access": "full" }
  ],
  "apiPermissions": [
    { "path": "/api/articles", "methods": ["GET", "POST", "PUT"] },
    { "path": "/api/media", "methods": ["GET", "POST"] }
  ]
}
```

### ูุซุงู 2: ุงุฌุงุฏ ููุด "ูพุดุชุจุงู ฺฉุงุฑุจุฑุงู"

```json
{
  "name": "ูพุดุชุจุงู ฺฉุงุฑุจุฑุงู",
  "slug": "user_support",
  "description": "ูพุงุณุฎฺฏู ุจู ฺฉุงุฑุจุฑุงู ู ูุฏุฑุช ุชฺฉุชโูุง",
  "isSystem": false,
  "menuPermissions": [
    { "menuId": "dashboard", "access": "view" },
    { "menuId": "users", "access": "view" },
    { "menuId": "tickets", "access": "full" }
  ],
  "apiPermissions": [
    { "path": "/api/users", "methods": ["GET"] },
    { "path": "/api/tickets", "methods": ["GET", "PUT"] }
  ]
}
```

### ูุซุงู 3: ุงุฌุงุฏ ููุด "ูุฏุฑ ุฑูุฏุงุฏูุง"

```json
{
  "name": "ูุฏุฑ ุฑูุฏุงุฏูุง",
  "slug": "event_manager",
  "description": "ุงุฌุงุฏ ู ูุฏุฑุช ุฑูุฏุงุฏูุง",
  "isSystem": false,
  "menuPermissions": [
    { "menuId": "dashboard", "access": "view" },
    { "menuId": "events", "access": "full" },
    { "menuId": "bookings", "access": "view" }
  ],
  "apiPermissions": [
    { "path": "/api/events", "methods": ["GET", "POST", "PUT", "DELETE"] },
    { "path": "/api/bookings", "methods": ["GET"] }
  ]
}
```

---

## ููุดโูุง ุณุณุชู ูพุดโูุฑุถ

### 1. Admin (ูุฏุฑ ฺฉู)

- **Slug:** `admin`
- **ุฏุณุชุฑุณ:** ฺฉุงูู ุจู ุชูุงู ููููุง ู API ูุง
- **ูุงุจู ุญุฐู:** ุฎุฑ

### 2. Event Owner (ูุงูฺฉ ุฑูุฏุงุฏ)

- **Slug:** `event_owner`
- **ุฏุณุชุฑุณ:** ุงุฌุงุฏ ู ูุฏุฑุช ุฑูุฏุงุฏูุง ุฎูุฏ
- **ูุงุจู ุญุฐู:** ุฎุฑ

### 3. User (ฺฉุงุฑุจุฑ ุนุงุฏ)

- **Slug:** `user`
- **ุฏุณุชุฑุณ:** ุฏุณุชุฑุณโูุง ูุญุฏูุฏ ฺฉุงุฑุจุฑ
- **ูุงุจู ุญุฐู:** ุฎุฑ

---

## ุชูุณุนู ู ุณูุงุฑุดโุณุงุฒ

### ุงูุฒูุฏู ููู ุฌุฏุฏ

1. ููู ุฑุง ุจู ุฏุชุงุจุณ ุงุถุงูู ฺฉูุฏ (ุงุฒ ุทุฑู seed ุง ูุณุชููุงู):

```javascript
{
  menuId: "reports",
  title: { fa: "ฺฏุฒุงุฑุดโูุง", en: "Reports" },
  path: "/admin/reports",
  parentId: null,
  icon: "๐",
  order: 5,
  isActive: true,
  isVisible: true,
  defaultRoles: ["admin"]
}
```

2. ููู ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุฏุฑ Menu Tree View ููุงุด ุฏุงุฏู ูโุดูุฏ.

### ุงูุฒูุฏู API Endpoint ุฌุฏุฏ

1. Endpoint ุฑุง ุจู ุฏุชุงุจุณ ุงุถุงูู ฺฉูุฏ:

```javascript
{
  path: "/api/admin/reports",
  availableMethods: ["GET", "POST"],
  module: "reports",
  category: "admin",
  title: "ูุฏุฑุช ฺฏุฒุงุฑุดโูุง",
  description: "ุงุฌุงุฏ ู ูุดุงูุฏู ฺฏุฒุงุฑุดโูุง",
  defaultRoles: ["admin"],
  isPublic: false,
  isActive: true
}
```

2. Endpoint ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุฏุฑ API Permission Grid ููุงุด ุฏุงุฏู ูโุดูุฏ.

---

## ูฺฉุงุช ููู

### โ DO (ุงูุฌุงู ุฏูุฏ)

- ููุดู ููุดโูุง ุณุณุชู ุฑุง ุญูุธ ฺฉูุฏ
- ูุจู ุงุฒ ุญุฐู ููุดุ ูุทูุฆู ุดูุฏ ฺฉู ฺฉุงุฑุจุฑ ุงุฒ ุขู ุงุณุชูุงุฏู ููโฺฉูุฏ
- ุงุฒ slug ูุง ูุนูุงุฏุงุฑ ู ููุญุตุฑ ุจู ูุฑุฏ ุงุณุชูุงุฏู ฺฉูุฏ
- ุฏุณุชุฑุณโูุง ุฑุง ุจู ุตูุฑุช ุฏูู ู ฺฉูุชุฑู ุฏุณุชุฑุณ ูุงุฒู (Principle of Least Privilege) ุชุนุฑู ฺฉูุฏ

### โ DON'T (ุงูุฌุงู ูุฏูุฏ)

- ููุดโูุง ุณุณุชู ุฑุง ุญุฐู ูฺฉูุฏ
- slug ููุดโูุง ุฑุง ูพุณ ุงุฒ ุงุฌุงุฏ ุชุบุฑ ูุฏูุฏ
- ุฏุณุชุฑุณ ฺฉุงูู (full) ุฑุง ุจุฏูู ูุงุฒ ุชุฎุตุต ูุฏูุฏ
- ููู ฺฉุงุฑุจุฑุงู ุฑุง admin ูฺฉูุฏ

---

## ูพุดุชุจุงู ู ุชุณุช

### ุชุณุช ููุด ุฌุฏุฏ

1. ููุด ุฑุง ุงุฌุงุฏ ฺฉูุฏ
2. ุขู ุฑุง ุจู ฺฉ ฺฉุงุฑุจุฑ ุชุณุช ุชุฎุตุต ุฏูุฏ
3. ุจุง ุขู ฺฉุงุฑุจุฑ ูุงฺฏู ฺฉูุฏ
4. ุฏุณุชุฑุณโูุง ุฑุง ุชุณุช ฺฉูุฏ

### ุฑูุน ุงุดฺฉุงู

ุฏุฑ ุตูุฑุช ูุดฺฉู ุฏุฑ ุฏุณุชุฑุณโูุง:

1. ุจุฑุฑุณ ฺฉูุฏ ฺฉู ููุด ุจู ฺฉุงุฑุจุฑ ุชุฎุตุต ุฏุงุฏู ุดุฏู ุงุณุช
2. ุจุฑุฑุณ ฺฉูุฏ ฺฉู ููู/API ุฏุฑ ููุด ุชุนุฑู ุดุฏู ุงุณุช
3. ูุงฺฏโูุง ุณุฑูุฑ ุฑุง ฺฺฉ ฺฉูุฏ
4. ุงุฒ ุตูุญู seed ุงุณุชูุงุฏู ฺฉูุฏ ุชุง ุฏุงุฏูโูุง ุงููู ุจุงุฒุณุงุฒ ุดููุฏ

---

## ุชุบุฑุงุช ุขูุฏู

- [ ] Import/Export ููุดโูุง ุจู ุตูุฑุช JSON
- [ ] ฺฉูพ ฺฉุฑุฏู ููุดโูุง
- [ ] ููุงุด ฺฏุฑุงูฺฉ ุงุฑุชุจุงุท ููุดโูุง
- [ ] ุชุงุฑุฎฺู ุชุบุฑุงุช ููุดโูุง
- [ ] ุฏุณุชุฑุณโูุง ูููุช (ุจุง ุชุงุฑุฎ ุงููุถุง)
- [ ] ุฏุณุชุฑุณ ุจุฑ ุงุณุงุณ ุดุฑุท (Conditional Access)

---

**ุขุฎุฑู ุจูโุฑูุฒุฑุณุงู:** ุงฺฉุชุจุฑ 2025  
**ูุณุฎู:** 1.0.0  
**ูุณุชูุฏุงุช ุจุดุชุฑ:** [RBAC_GUIDE.md](./RBAC_GUIDE.md)

